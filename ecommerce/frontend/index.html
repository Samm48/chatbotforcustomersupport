<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ShopSmart - AI E-Commerce</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: Arial, sans-serif; background: #f5f5f5; }
        
        /* Header & Navigation */
        .header { background: #007bff; color: white; padding: 20px 30px; }
        .nav { display: flex; justify-content: space-between; align-items: center; }
        .nav-brand { font-size: 1.8rem; font-weight: bold; }
        .nav-links { display: flex; gap: 20px; align-items: center; }
        .nav-link { color: white; text-decoration: none; padding: 8px 15px; border-radius: 5px; transition: background 0.3s; }
        .nav-link:hover { background: rgba(255,255,255,0.2); }
        .cart-icon { position: relative; cursor: pointer; }
        .cart-count { position: absolute; top: -8px; right: -8px; background: #ff4757; color: white; border-radius: 50%; width: 20px; height: 20px; font-size: 12px; display: flex; align-items: center; justify-content: center; }
        
        /* Live Status Indicator */
        .live-status { display: inline-block; margin-left: 15px; font-size: 0.9rem; }
        .status-indicator { display: inline-block; width: 10px; height: 10px; border-radius: 50%; margin-right: 5px; }
        .status-online { background: #28a745; }
        .status-offline { background: #dc3545; }
        
        /* Main Content */
        .main-content { display: flex; min-height: calc(100vh - 160px); }
        .sidebar { width: 250px; background: white; padding: 20px; box-shadow: 2px 0 5px rgba(0,0,0,0.1); }
        .content-area { flex: 1; padding: 30px; }
        
        /* Page Containers */
        .page { display: none; }
        .page.active { display: block; }
        
        /* Login/Register Page */
        .auth-container { max-width: 400px; margin: 50px auto; background: white; padding: 30px; border-radius: 10px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
        .auth-title { text-align: center; margin-bottom: 30px; color: #007bff; }
        .form-group { margin-bottom: 20px; }
        .form-label { display: block; margin-bottom: 8px; font-weight: bold; color: #555; }
        .form-input { width: 100%; padding: 12px; border: 1px solid #ddd; border-radius: 5px; font-size: 16px; }
        .form-input:focus { outline: none; border-color: #007bff; }
        .auth-btn { width: 100%; padding: 12px; background: #007bff; color: white; border: none; border-radius: 5px; font-size: 16px; cursor: pointer; transition: background 0.3s; }
        .auth-btn:hover { background: #0056b3; }
        .auth-btn-secondary { background: #6c757d; }
        .auth-btn-secondary:hover { background: #5a6268; }
        .auth-error { color: #dc3545; margin-top: 10px; text-align: center; }
        .auth-success { color: #28a745; margin-top: 10px; text-align: center; }
        .auth-toggle { text-align: center; margin-top: 20px; }
        .toggle-link { color: #007bff; cursor: pointer; text-decoration: underline; }
        .auth-tabs { display: flex; margin-bottom: 30px; border-bottom: 2px solid #eee; }
        .auth-tab { flex: 1; padding: 15px; text-align: center; cursor: pointer; background: none; border: none; font-size: 16px; color: #666; }
        .auth-tab.active { color: #007bff; border-bottom: 2px solid #007bff; margin-bottom: -2px; }
        
        /* Admin Dashboard */
        .admin-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 30px; }
        .admin-card { background: white; border-radius: 10px; padding: 20px; margin-bottom: 20px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
        .admin-actions { display: flex; gap: 10px; margin-top: 15px; }
        .admin-table { width: 100%; border-collapse: collapse; margin-top: 20px; }
        .admin-table th, .admin-table td { padding: 12px; text-align: left; border-bottom: 1px solid #eee; }
        .admin-table th { background: #f8f9fa; font-weight: bold; color: #333; }
        .admin-table tr:hover { background: #f8f9fa; }
        
        /* User Management */
        .user-role { padding: 5px 10px; border-radius: 15px; font-size: 0.9rem; }
        .role-admin { background: #dc3545; color: white; }
        .role-customer { background: #28a745; color: white; }
        
        /* Products Grid */
        .products { display: grid; grid-template-columns: repeat(auto-fill, minmax(250px, 1fr)); gap: 20px; }
        .product-card { background: white; padding: 20px; border-radius: 10px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); text-align: center; }
        .price { color: #007bff; font-size: 1.5rem; font-weight: bold; margin: 10px 0; }
        .btn { background: #28a745; color: white; border: none; padding: 10px 20px; border-radius: 5px; cursor: pointer; margin: 5px; transition: background 0.3s; }
        .btn:hover { background: #218838; }
        .btn-danger { background: #dc3545; }
        .btn-danger:hover { background: #c82333; }
        .btn-secondary { background: #6c757d; }
        .btn-secondary:hover { background: #5a6268; }
        .btn-warning { background: #ffc107; color: #000; }
        .btn-warning:hover { background: #e0a800; }
        .btn-info { background: #17a2b8; color: white; }
        .btn-info:hover { background: #138496; }
        
        /* Cart & Checkout */
        .cart-items { background: white; border-radius: 10px; padding: 20px; margin-bottom: 20px; }
        .cart-item { display: flex; justify-content: space-between; align-items: center; padding: 15px; border-bottom: 1px solid #eee; }
        .cart-item:last-child { border-bottom: none; }
        .cart-item-info { flex: 1; }
        .cart-item-controls { display: flex; align-items: center; gap: 10px; }
        .quantity-control { display: flex; align-items: center; gap: 10px; }
        .quantity-btn { width: 30px; height: 30px; border-radius: 50%; border: 1px solid #ddd; background: white; cursor: pointer; }
        
        .checkout-summary { background: white; border-radius: 10px; padding: 20px; }
        .summary-row { display: flex; justify-content: space-between; padding: 10px 0; border-bottom: 1px solid #eee; }
        .summary-row.total { border-bottom: none; font-weight: bold; font-size: 1.2rem; color: #007bff; }
        
        /* Dashboard */
        .dashboard-cards { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; margin-bottom: 30px; }
        .dashboard-card { background: white; padding: 20px; border-radius: 10px; text-align: center; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
        .dashboard-card h3 { color: #007bff; margin-bottom: 10px; }
        .dashboard-card .value { font-size: 2rem; font-weight: bold; }
        
        /* Order History */
        .order-card { background: white; border-radius: 10px; padding: 20px; margin-bottom: 15px; box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
        .order-header { display: flex; justify-content: space-between; margin-bottom: 10px; }
        .order-status { padding: 5px 10px; border-radius: 15px; font-size: 0.9rem; }
        .status-delivered { background: #d4edda; color: #155724; }
        .status-pending { background: #fff3cd; color: #856404; }
        .status-shipped { background: #cce5ff; color: #004085; }
        
        /* Modal */
        .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 2000; }
        .modal.active { display: flex; align-items: center; justify-content: center; }
        .modal-content { background: white; border-radius: 10px; padding: 30px; max-width: 500px; width: 90%; max-height: 90vh; overflow-y: auto; }
        .modal-wide { max-width: 800px; }
        
        /* Footer */
        .footer { background: #333; color: white; text-align: center; padding: 20px; margin-top: 40px; }
        
        /* Chatbot */
        .chat-btn { position: fixed; bottom: 20px; right: 20px; background: #007bff; color: white; border: none; border-radius: 50%; width: 60px; height: 60px; font-size: 24px; cursor: pointer; z-index: 1000; }
        .loading { text-align: center; padding: 40px; color: #666; }
        
        /* Utility Classes */
        .hidden { display: none; }
        .text-center { text-align: center; }
        .mt-20 { margin-top: 20px; }
        .mb-20 { margin-bottom: 20px; }
        
        /* Category Buttons */
        .category-btn.active {
            background: #007bff;
            color: white;
            border: none;
            padding: 8px 15px;
            border-radius: 5px;
            cursor: pointer;
            width: 100%;
            text-align: left;
            margin: 5px 0;
        }

        .category-btn {
            background: #f8f9fa;
            color: #333;
            border: 1px solid #ddd;
            padding: 8px 15px;
            border-radius: 5px;
            cursor: pointer;
            width: 100%;
            text-align: left;
            margin: 5px 0;
            transition: all 0.3s;
        }

        .category-btn:hover {
            background: #e9ecef;
        }
        
        /* Human Support Section */
        .support-section {
            background: #f8f9fa;
            border-left: 4px solid #4CAF50;
            border-radius: 8px;
            padding: 20px;
            margin: 20px 0;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, sans-serif;
        }
        
        .support-container h3 {
            color: #2c3e50;
            margin-top: 0;
            margin-bottom: 15px;
            font-size: 1.5rem;
        }
        
        .support-options {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 20px;
            margin: 25px 0;
        }
        
        .support-option {
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.05);
        }
        
        .support-option h4 {
            color: #3498db;
            margin-top: 0;
            margin-bottom: 10px;
            font-size: 1.2rem;
        }
        
        .phone-number {
            background: #f1f8ff;
            padding: 12px;
            border-radius: 6px;
            margin: 15px 0;
            font-size: 1.3rem;
            text-align: center;
        }
        
        .support-btn {
            background: #4CAF50;
            color: white;
            border: none;
            padding: 12px 20px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 1rem;
            font-weight: 600;
            width: 100%;
            transition: background 0.3s;
            margin-top: 10px;
        }
        
        .support-btn.secondary {
            background: #3498db;
        }
        
        .support-btn:hover {
            background: #45a049;
        }
        
        .support-btn.secondary:hover {
            background: #2980b9;
        }
        
        .callback-input {
            width: 100%;
            padding: 12px;
            border: 1px solid #ddd;
            border-radius: 6px;
            font-size: 1rem;
            box-sizing: border-box;
            margin-bottom: 10px;
        }
        
        .status-message {
            margin-top: 10px;
            padding: 8px;
            border-radius: 4px;
            text-align: center;
            font-size: 0.9rem;
        }
        
        .support-note {
            margin-top: 20px;
            padding-top: 15px;
            border-top: 1px dashed #ddd;
            color: #666;
            text-align: center;
        }
        
        /* Animations */
        @keyframes slideIn {
            from { transform: translateX(100%); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }
        
        @keyframes slideOut {
            from { transform: translateX(0); opacity: 1; }
            to { transform: translateX(100%); opacity: 0; }
        }
        
        .status-processing { background: #fff3cd; color: #856404; }
    </style>
</head>
<body>
    <!-- Header with Navigation -->
    <div class="header">
        <div class="nav">
            <div class="nav-brand">üõçÔ∏è ShopSmart</div>
            <div class="nav-links">
                <a href="#" class="nav-link" data-page="home">Home</a>
                <a href="#" class="nav-link" data-page="products">Products</a>
                <a href="#" class="nav-link" data-page="cart">
                    üõí Cart <span class="cart-count" id="cart-count">0</span>
                </a>
                <a href="#" class="nav-link" data-page="dashboard">Dashboard</a>
                <a href="#" class="nav-link" data-page="admin" id="admin-link" style="display: none;">Admin</a>
                <div class="user-menu">
                    <span id="user-greeting">Guest</span>
                    <button id="logout-btn" style="display: none; margin-left: 10px; padding: 5px 10px; background: #dc3545; color: white; border: none; border-radius: 3px; cursor: pointer;">Logout</button>
                </div>
                <div class="live-status">
                    <span class="status-indicator status-offline" id="connection-status-indicator"></span>
                    <span id="connection-status-text">Offline</span>
                    <span style="margin-left: 10px;">üë• <span id="live-visitors">0</span></span>
                </div>
            </div>
        </div>
        <small id="backend-status">Connecting to backend...</small>
    </div>

    <!-- Main Content Area -->
    <div class="main-content">
        <!-- Sidebar -->
        <div class="sidebar" id="sidebar">
            <h3>Categories</h3>
            <ul id="category-list" style="list-style: none; padding: 10px 0;">
                <li><button class="category-btn active" data-category="all">All Products</button></li>
                <li><button class="category-btn" data-category="Electronics">Electronics</button></li>
                <li><button class="category-btn" data-category="Sports">Sports</button></li>
                <li><button class="category-btn" data-category="Home">Home</button></li>
            </ul>
            
            <h3>Price Range</h3>
            <div style="padding: 10px 0;">
                <input type="range" id="price-slider" min="0" max="100000" value="100000" style="width: 100%;">
                <div>Up to: ksh. <span id="price-max">100,000</span></div>
            </div>
            
            <h3>Quick Stats</h3>
            <div style="font-size: 0.9rem; color: #666;">
                <div>Items in cart: <span id="sidebar-cart-count">0</span></div>
                <div>Total value: ksh. <span id="sidebar-cart-total">0</span></div>
            </div>
        </div>

        <!-- Page Content -->
        <div class="content-area">
            <!-- Login/Register Page -->
            <div id="auth-page" class="page active">
                <div class="auth-container">
                    <h1 class="auth-title">üîê ShopSmart</h1>
                    
                    <!-- Tabs -->
                    <div class="auth-tabs">
                        <button class="auth-tab active" id="login-tab">Login</button>
                        <button class="auth-tab" id="register-tab">Register</button>
                    </div>
                    
                    <!-- Login Form -->
                    <div id="login-form">
                        <h2 style="margin-bottom: 20px; color: #333;">Welcome Back!</h2>
                        <div class="form-group">
                            <label class="form-label">Email</label>
                            <input type="email" id="login-email" class="form-input" placeholder="your@email.com">
                        </div>
                        <div class="form-group">
                            <label class="form-label">Password</label>
                            <input type="password" id="login-password" class="form-input" placeholder="Enter password">
                        </div>
                        <button class="auth-btn" id="login-btn">Login</button>
                        <div class="auth-toggle">
                            <span>New user? </span>
                            <span class="toggle-link" id="show-register">Create an account</span>
                        </div>
                        <div class="auth-error" id="login-error"></div>
                        <div class="auth-success" id="login-success"></div>
                        
                       
                    </div>
                    
                    <!-- Register Form -->
                    <div id="register-form" style="display: none;">
                        <h2 style="margin-bottom: 20px; color: #333;">Create Account</h2>
                        <div class="form-group">
                            <label class="form-label">Full Name</label>
                            <input type="text" id="register-name" class="form-input" placeholder="John Doe">
                        </div>
                        <div class="form-group">
                            <label class="form-label">Email</label>
                            <input type="email" id="register-email" class="form-input" placeholder="your@email.com">
                        </div>
                        <div class="form-group">
                            <label class="form-label">Password</label>
                            <input type="password" id="register-password" class="form-input" placeholder="Minimum 6 characters">
                        </div>
                        <div class="form-group">
                            <label class="form-label">Confirm Password</label>
                            <input type="password" id="register-confirm-password" class="form-input" placeholder="Confirm password">
                        </div>
                        <div class="form-group">
                            <label class="form-label">Phone Number</label>
                            <input type="tel" id="register-phone" class="form-input" placeholder="0712 345 678">
                        </div>
                        <button class="auth-btn" id="register-btn">Create Account</button>
                        <div class="auth-toggle">
                            <span>Already have an account? </span>
                            <span class="toggle-link" id="show-login">Sign in</span>
                        </div>
                        <div class="auth-error" id="register-error"></div>
                        <div class="auth-success" id="register-success"></div>
                    </div>
                </div>
            </div>

            <!-- Home Page -->
            <div id="home-page" class="page">
                <h1>Welcome to ShopSmart</h1>
                <p>Your AI-powered shopping destination</p>
                
                <div class="dashboard-cards" style="margin-top: 30px;">
                    <div class="dashboard-card">
                        <h3>Total Products</h3>
                        <div class="value" id="total-products">0</div>
                    </div>
                    <div class="dashboard-card">
                        <h3>Cart Total</h3>
                        <div class="value">ksh. <span id="home-cart-total">0</span></div>
                    </div>
                    <div class="dashboard-card">
                        <h3>Special Offers</h3>
                        <div>Free shipping on orders over ksh. 10,000</div>
                    </div>
                </div>
                
                <h2 class="mt-20">Featured Products</h2>
                <div class="products" id="featured-products">
                    <!-- Featured products will load here -->
                </div>
            </div>

            <!-- Products Page -->
            <div id="products-page" class="page">
                <h1>All Products</h1>
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                    <div>Showing <span id="product-count">0</span> products</div>
                    <select id="sort-select" style="padding: 8px 15px; border-radius: 5px;">
                        <option value="price-low">Price: Low to High</option>
                        <option value="price-high">Price: High to Low</option>
                        <option value="name">Name A-Z</option>
                    </select>
                </div>
                <div class="products" id="all-products">
                    <!-- All products will load here -->
                </div>
            </div>

            <!-- Cart Page -->
            <div id="cart-page" class="page">
                <h1>Your Shopping Cart</h1>
                
                <div class="cart-items" id="cart-items-container">
                    <div class="text-center" style="padding: 40px; color: #666;">
                        Your cart is empty
                    </div>
                </div>
                
                <div class="checkout-summary">
                    <h3>Order Summary</h3>
                    <div class="summary-row">
                        <span>Subtotal</span>
                        <span>ksh. <span id="subtotal">0</span></span>
                    </div>
                    <div class="summary-row">
                        <span>Shipping</span>
                        <span>ksh. <span id="shipping">0</span></span>
                    </div>
                    <div class="summary-row">
                        <span>Tax (10%)</span>
                        <span>ksh. <span id="tax">0</span></span>
                    </div>
                    <div class="summary-row total">
                        <span>Total</span>
                        <span>ksh. <span id="total">0</span></span>
                    </div>
                    
                    <button class="btn" style="width: 100%; margin-top: 20px;" id="checkout-btn">
                        Proceed to Checkout
                    </button>
                </div>
            </div>

            <!-- Dashboard Page -->
            <div id="dashboard-page" class="page">
                <h1>My Dashboard</h1>
                
                <div class="dashboard-cards">
                    <div class="dashboard-card">
                        <h3>Total Orders</h3>
                        <div class="value" id="total-orders">0</div>
                    </div>
                    <div class="dashboard-card">
                        <h3>Total Spent</h3>
                        <div class="value">ksh. <span id="total-spent">0</span></div>
                    </div>
                    <div class="dashboard-card">
                        <h3>Current Cart</h3>
                        <div class="value"><span id="dashboard-cart-count">0</span> items</div>
                    </div>
                </div>
                
                <h2>Order History</h2>
                <div id="order-history">
                    <div class="order-card">
                        <div class="order-header">
                            <div>
                                <strong>Order #1001</strong><br>
                                <small>Dec 15, 2024</small>
                            </div>
                            <span class="order-status status-delivered">Delivered</span>
                        </div>
                        <p>Wireless Headphones (1) - ksh. 3,000</p>
                        <p>Total: ksh. 3,300</p>
                    </div>
                </div>
                
                <h2>Account Details</h2>
                <div style="background: white; padding: 20px; border-radius: 10px;">
                    <div style="margin-bottom: 15px;">
                        <strong>Name:</strong> <span id="user-name">Guest User</span>
                    </div>
                    <div style="margin-bottom: 15px;">
                        <strong>Email:</strong> <span id="user-email">guest@example.com</span>
                    </div>
                    <div style="margin-bottom: 15px;">
                        <strong>Phone:</strong> <span id="user-phone">Not provided</span>
                    </div>
                    <div style="margin-bottom: 15px;">
                        <strong>Member Since:</strong> <span id="user-joined">Today</span>
                    </div>
                    <button class="btn-secondary" id="edit-profile-btn">Edit Profile</button>
                </div>
            </div>

            <!-- Admin Dashboard Page -->
            <div id="admin-page" class="page">
                <div class="admin-header">
                    <h1>üõ†Ô∏è Admin Dashboard</h1>
                    <div>
                        <button class="btn" id="add-product-btn">‚ûï Add Product</button>
                        <button class="btn-info" id="view-users-btn">üë• View Users</button>
                        <button class="btn-secondary" id="refresh-admin-btn">üîÑ Refresh</button>
                    </div>
                </div>
                
                <!-- Admin Stats -->
                <div class="dashboard-cards">
                    <div class="dashboard-card">
                        <h3>Total Users</h3>
                        <div class="value" id="admin-total-users">0</div>
                    </div>
                    <div class="dashboard-card">
                        <h3>Total Products</h3>
                        <div class="value" id="admin-total-products">0</div>
                    </div>
                    <div class="dashboard-card">
                        <h3>Total Orders</h3>
                        <div class="value" id="admin-total-orders">0</div>
                    </div>
                    <div class="dashboard-card">
                        <h3>Total Revenue</h3>
                        <div class="value">ksh. <span id="admin-total-revenue">0</span></div>
                    </div>
                </div>
                
                <!-- Products Management -->
                <div class="admin-card">
                    <h2>üì¶ Product Management</h2>
                    <table class="admin-table">
                        <thead>
                            <tr>
                                <th>ID</th>
                                <th>Image</th>
                                <th>Name</th>
                                <th>Price (KSH)</th>
                                <th>Category</th>
                                <th>Stock</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="admin-products-table">
                            <tr>
                                <td colspan="7" class="text-center">Loading products...</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
                
                <!-- Users Management -->
                <div class="admin-card">
                    <h2>üë• User Management</h2>
                    <table class="admin-table">
                        <thead>
                            <tr>
                                <th>ID</th>
                                <th>Name</th>
                                <th>Email</th>
                                <th>Phone</th>
                                <th>Role</th>
                                <th>Joined</th>
                                <th>Orders</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="admin-users-table">
                            <tr>
                                <td colspan="8" class="text-center">Click "View Users" to load user data</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
                
                <!-- Orders Management -->
                <div class="admin-card">
                    <h2>üìã Order Management</h2>
                    <table class="admin-table">
                        <thead>
                            <tr>
                                <th>Order ID</th>
                                <th>Customer</th>
                                <th>Date</th>
                                <th>Amount</th>
                                <th>Status</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="admin-orders-table">
                            <tr>
                                <td colspan="6" class="text-center">Loading orders...</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
                
                <!-- Quick Actions -->
                <div class="admin-card">
                    <h2>‚ö° Quick Actions</h2>
                    <div class="admin-actions">
                        <button class="btn" id="export-products-btn">üì• Export Products</button>
                        <button class="btn-info" id="export-users-btn">üë• Export Users</button>
                        <button class="btn-warning" id="clear-cache-btn">üßπ Clear Cache</button>
                        <button class="btn-danger" id="reset-demo-btn">üîÑ Reset Demo Data</button>
                    </div>
                </div>
            </div>

            <!-- Checkout Modal -->
            <div id="checkout-modal" class="modal">
                <div class="modal-content">
                    <h2>Checkout</h2>
                    <form id="checkout-form">
                        <div style="margin-bottom: 15px;">
                            <label>Full Name</label>
                            <input type="text" id="checkout-name" required style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 5px;" value="">
                        </div>
                        <div style="margin-bottom: 15px;">
                            <label>Email</label>
                            <input type="email" id="checkout-email" required style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 5px;" value="">
                        </div>
                        <div style="margin-bottom: 15px;">
                            <label>Phone Number</label>
                            <input type="tel" id="checkout-phone" required style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 5px;" placeholder="0712 345 678">
                        </div>
                        <div style="margin-bottom: 15px;">
                            <label>Address</label>
                            <textarea id="checkout-address" required rows="3" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 5px;" placeholder="Your full delivery address"></textarea>
                        </div>
                        <div style="margin-bottom: 15px;">
                            <label>Payment Method</label>
                            <select id="checkout-payment" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 5px;">
                                <option>Credit Card</option>
                                <option>MPesa</option>
                                <option>Cash on Delivery</option>
                            </select>
                        </div>
                        
                        <div style="background: #f8f9fa; padding: 15px; border-radius: 5px; margin-bottom: 20px;">
                            <div style="display: flex; justify-content: space-between;">
                                <span>Total Amount:</span>
                                <strong>ksh. <span id="checkout-total">0</span></strong>
                            </div>
                        </div>
                        
                        <div style="display: flex; gap: 10px;">
                            <button type="button" class="btn-secondary" id="cancel-checkout">Cancel</button>
                            <button type="submit" class="btn">Place Order</button>
                        </div>
                    </form>
                </div>
            </div>
            
            <!-- Add/Edit Product Modal -->
            <div id="product-modal" class="modal">
                <div class="modal-content modal-wide">
                    <h2 id="product-modal-title">Add New Product</h2>
                    <form id="product-form">
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 20px;">
                            <div>
                                <div class="form-group">
                                    <label class="form-label">Product Name *</label>
                                    <input type="text" id="product-name" class="form-input" required placeholder="Wireless Headphones">
                                </div>
                                <div class="form-group">
                                    <label class="form-label">Price (KSH) *</label>
                                    <input type="number" id="product-price" class="form-input" required placeholder="30000" min="0" step="100">
                                </div>
                                <div class="form-group">
                                    <label class="form-label">Category *</label>
                                    <select id="product-category" class="form-input" required>
                                        <option value="">Select Category</option>
                                        <option value="Electronics">Electronics</option>
                                        <option value="Sports">Sports</option>
                                        <option value="Home">Home</option>
                                        <option value="Accessories">Accessories</option>
                                        <option value="Fashion">Fashion</option>
                                    </select>
                                </div>
                            </div>
                            <div>
                                <div class="form-group">
                                    <label class="form-label">Stock Quantity *</label>
                                    <input type="number" id="product-stock" class="form-input" required placeholder="50" min="0">
                                </div>
                                <div class="form-group">
                                    <label class="form-label">Image URL</label>
                                    <input type="text" id="product-image" class="form-input" placeholder="https://images.unsplash.com/photo-...">
                                </div>
                                <div class="form-group">
                                    <label class="form-label">Featured</label>
                                    <select id="product-featured" class="form-input">
                                        <option value="false">No</option>
                                        <option value="true">Yes</option>
                                    </select>
                                </div>
                            </div>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Description</label>
                            <textarea id="product-description" class="form-input" rows="4" placeholder="Product description..."></textarea>
                        </div>
                        
                        <div style="display: flex; gap: 10px; margin-top: 20px;">
                            <button type="button" class="btn-secondary" id="cancel-product">Cancel</button>
                            <button type="submit" class="btn" id="save-product-btn">Save Product</button>
                        </div>
                        <input type="hidden" id="product-id">
                    </form>
                </div>
            </div>
            
            <!-- Edit User Modal -->
            <div id="user-modal" class="modal">
                <div class="modal-content">
                    <h2 id="user-modal-title">Edit User</h2>
                    <form id="user-form">
                        <div class="form-group">
                            <label class="form-label">Full Name</label>
                            <input type="text" id="edit-user-name" class="form-input" required>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Email</label>
                            <input type="email" id="edit-user-email" class="form-input" required>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Phone Number</label>
                            <input type="tel" id="edit-user-phone" class="form-input">
                        </div>
                        <div class="form-group">
                            <label class="form-label">Role</label>
                            <select id="edit-user-role" class="form-input" required>
                                <option value="customer">Customer</option>
                                <option value="admin">Admin</option>
                            </select>
                        </div>
                        
                        <div style="display: flex; gap: 10px; margin-top: 20px;">
                            <button type="button" class="btn-secondary" id="cancel-user">Cancel</button>
                            <button type="submit" class="btn" id="save-user-btn">Save Changes</button>
                        </div>
                        <input type="hidden" id="edit-user-id">
                    </form>
                </div>
            </div>

            <!-- Human Support Section -->
            <section id="human-support" class="support-section" style="display: none;">
                <div class="support-container">
                    <h3>üßë‚Äçüíª Connect with a Human Agent</h3>
                    <p>Our AI couldn't resolve your issue? Our support team is here to help you directly.</p>
                    
                    <div class="support-options">
                        <!-- Option 1: Live Chat -->
                        <div class="support-option">
                            <h4>üì± Live Text Support</h4>
                            <p>Chat directly with an available agent.</p>
                            <button id="startLiveChatBtn" class="support-btn">Start Live Chat</button>
                            <div id="liveChatStatus" class="status-message"></div>
                        </div>
                        
                        <!-- Option 2: Phone Support -->
                        <div class="support-option">
                            <h4>üìû Call  Support</h4>
                            <p>Speak directly with our team.</p>
                            <div class="phone-number">
                                <strong>+254 700 123 456</strong>
                                <p><em>Available Mon-Fri, 8 AM - 5 PM EAT</em></p>
                            </div>
                            <button id="copyPhoneBtn" class="support-btn secondary">Copy Number</button>
                        </div>
                        
                        <!-- Option 3: Callback Request -->
                        <div class="support-option">
                            <h4>‚è∞ Request a Callback</h4>
                            <p>Leave your number and we'll call you back.</p>
                            <input type="tel" id="callbackNumber" placeholder="+254 XXX XXX XXX" class="callback-input">
                            <button id="requestCallbackBtn" class="support-btn">Request Callback</button>
                            <div id="callbackStatus" class="status-message"></div>
                        </div>
                    </div>
                    
                    <div class="support-note">
                        <p><small>Typical response time: <strong>Under 5 minutes</strong> during business hours.</small></p>
                    </div>
                </div>
            </section>
        </div>
    </div>

    <div class="footer">
        <p>¬© 2025 ShopSmart. All rights reserved.</p>
    </div>

    <!-- Chatbot HTML -->
    <div id="chatbot-modal" style="display: none; position: fixed; bottom: 90px; right: 20px; width: 350px; background: white; border-radius: 10px; box-shadow: 0 5px 20px rgba(0,0,0,0.2); z-index: 1000;">
        <div style="background: #007bff; color: white; padding: 15px; border-radius: 10px 10px 0 0; display: flex; justify-content: space-between; align-items: center;">
            <h3 style="margin: 0;">ü§ñ AI Shopping Assistant</h3>
            <button id="close-chat" style="background: none; border: none; color: white; font-size: 20px; cursor: pointer;">√ó</button>
        </div>
        
        <div id="chat-messages" style="height: 300px; overflow-y: auto; padding: 15px;">
            <div class="message bot" style="background: #f1f1f1; padding: 10px; border-radius: 10px; margin-bottom: 10px; max-width: 80%;">
                Hello! I'm your AI shopping assistant. How can I help you today?
            </div>
        </div>
        
        <div style="padding: 15px; border-top: 1px solid #eee;">
            <div style="display: flex; gap: 10px;">
                <input type="text" id="chat-input" placeholder="Type your message..." 
                       style="flex: 1; padding: 10px; border: 1px solid #ddd; border-radius: 20px;">
                <button id="send-chat" style="background: #007bff; color: white; border: none; border-radius: 20px; padding: 0 20px; cursor: pointer;">
                    Send
                </button>
            </div>
            <div style="margin-top: 10px; display: flex; gap: 5px; flex-wrap: wrap;">
                <button class="quick-question" data-question="What products do you have?" style="background: #f8f9fa; border: 1px solid #ddd; border-radius: 15px; padding: 5px 10px; font-size: 12px; cursor: pointer;">
                    What products?
                </button>
                <button class="quick-question" data-question="How do I track my order?" style="background: #f8f9fa; border: 1px solid #ddd; border-radius: 15px; padding: 5px 10px; font-size: 12px; cursor: pointer;">
                    Track order
                </button>
                <button class="quick-question" data-question="What is your shipping policy?" style="background: #f8f9fa; border: 1px solid #ddd; border-radius: 15px; padding: 5px 10px; font-size: 12px; cursor: pointer;">
                    Shipping info
                </button>
                <button class="quick-question" data-question="How do I return an item?" style="background: #f8f9fa; border: 1px solid #ddd; border-radius: 15px; padding: 5px 10px; font-size: 12px; cursor: pointer;">
                    Returns
                </button>
            </div>
        </div>
    </div>

    <button class="chat-btn" id="chat-btn">üí¨</button>

    <!-- Socket.io CDN -->
    <script src="https://cdn.socket.io/4.7.2/socket.io.min.js"></script>

    <script>
        // ========== CHATBOT FUNCTIONALITY ==========
        let isChatOpen = false;
        let chatbotModal = null;
        let chatMessages = null;
        let chatInput = null;
        let sendChatBtn = null;
        let closeChatBtn = null;

        function initializeChatbot() {
            chatbotModal = document.getElementById('chatbot-modal');
            chatMessages = document.getElementById('chat-messages');
            chatInput = document.getElementById('chat-input');
            sendChatBtn = document.getElementById('send-chat');
            closeChatBtn = document.getElementById('close-chat');

            if (!chatbotModal || !chatMessages || !chatInput) {
                console.log('Chatbot elements not found, retrying...');
                setTimeout(initializeChatbot, 100);
                return;
            }

            console.log('‚úÖ Chatbot initialized successfully');

            // Toggle chat window
            document.getElementById('chat-btn').addEventListener('click', function() {
                isChatOpen = !isChatOpen;
                chatbotModal.style.display = isChatOpen ? 'block' : 'none';
                if (isChatOpen) {
                    chatInput.focus();
                }
            });

            // Close chat
            if (closeChatBtn) {
                closeChatBtn.addEventListener('click', function() {
                    isChatOpen = false;
                    chatbotModal.style.display = 'none';
                });
            }

            // Send message function
            function sendMessage() {
                const message = chatInput.value.trim();
                if (!message) return;
                
                // Add user message
                addMessage(message, 'user');
                chatInput.value = '';
                
                // Generate AI response
                setTimeout(() => {
                    const aiResponse = generateAIResponse(message);
                    addMessage(aiResponse, 'bot');
                    
                    // Also send via socket if connected
                    if (socket && socket.connected) {
                        socket.emit('send-chat-message', {
                            userId: currentUser.id || 'guest',
                            message: message,
                            timestamp: new Date()
                        });
                    }
                }, 500);
            }

            // Add message to chat
            function addMessage(text, sender) {
                const messageDiv = document.createElement('div');
                messageDiv.className = `message ${sender}`;
                messageDiv.style.background = sender === 'user' ? '#007bff' : '#f1f1f1';
                messageDiv.style.color = sender === 'user' ? 'white' : 'black';
                messageDiv.style.padding = '10px';
                messageDiv.style.borderRadius = '10px';
                messageDiv.style.marginBottom = '10px';
                messageDiv.style.maxWidth = '80%';
                messageDiv.style.marginLeft = sender === 'user' ? 'auto' : '0';
                messageDiv.textContent = text;
                
                chatMessages.appendChild(messageDiv);
                chatMessages.scrollTop = chatMessages.scrollHeight;
            }

            // Event listeners
            if (sendChatBtn) {
                sendChatBtn.addEventListener('click', sendMessage);
            }
            
            if (chatInput) {
                chatInput.addEventListener('keypress', function(e) {
                    if (e.key === 'Enter') sendMessage();
                });
            }

            // Quick question buttons
            document.querySelectorAll('.quick-question').forEach(button => {
                button.addEventListener('click', function() {
                    const question = this.getAttribute('data-question');
                    chatInput.value = question;
                    sendMessage();
                });
            });

            // Make functions globally available
            window.addMessage = addMessage;
            window.sendChatMessage = sendMessage;
        }

        // Initialize chatbot when DOM is loaded
        document.addEventListener('DOMContentLoaded', initializeChatbot);

        // ========== ENHANCED AI RESPONSE SYSTEM ==========
        
        // Enhanced AI Response Generator (Integrates backend logic)
        function generateAIResponse(message) {
            const msg = message.toLowerCase().trim();
            
            // Store user context
            const userId = currentUser.isLoggedIn ? currentUser.id : 'guest';
            const userContext = getUserContext(userId);
            userContext.lastMessage = msg;
            
            // Check for greetings
            if (isGreeting(msg)) {
                userContext.conversationState = 'greeted';
                return getGreetingResponse();
            }
            
            // Check if user wants human support
            if (wantsHumanSupport(msg)) {
                userContext.conversationState = 'human_requested';
                return getHumanSupportResponse();
            }
            
            // Product inquiries
            if (isProductInquiry(msg, userContext)) {
                return handleProductInquiry(msg);
            }
            
            // Order-related queries
            if (isOrderInquiry(msg)) {
                return handleOrderInquiry(msg);
            }
            
            // Shipping inquiries
            if (isShippingInquiry(msg)) {
                return handleShippingInquiry();
            }
            
            // Return and refund inquiries
            if (isReturnInquiry(msg)) {
                return handleReturnInquiry();
            }
            
            // Account and technical support
            if (isAccountInquiry(msg)) {
                return handleAccountInquiry();
            }
            
            // Price and discount inquiries
            if (isPriceInquiry(msg)) {
                return handlePriceInquiry();
            }
            
            // Fallback to context-aware response
            return getContextAwareResponse(userContext);
        }

        // Context management
        let userContexts = new Map();

        function getUserContext(userId) {
            if (!userId) return { conversationState: 'new' };
            
            if (!userContexts.has(userId)) {
                userContexts.set(userId, {
                    conversationState: 'new',
                    lastMessage: '',
                    mentionedProducts: [],
                    inquiryType: null
                });
            }
            return userContexts.get(userId);
        }

        // Greeting detection
        function isGreeting(message) {
            const greetings = ['hello', 'hi', 'hey', 'good morning', 'good afternoon', 'good evening'];
            return greetings.some(greeting => message.includes(greeting));
        }

        function getGreetingResponse() {
            const greetings = [
                "Hello! Welcome to ShopSmart! How can I assist you today?",
                "Hi there! I'm your AI shopping assistant. What can I help you with?",
                "Welcome! I'm here to help with products, orders, or any questions you might have."
            ];
            return greetings[Math.floor(Math.random() * greetings.length)];
        }

        // Human support request
        function wantsHumanSupport(message) {
            const humanTerms = ['human', 'person', 'agent', 'representative', 'real person', 'talk to someone'];
            return humanTerms.some(term => message.includes(term));
        }

        function getHumanSupportResponse() {
            // Show human support section
            if (typeof showHumanSupport === 'function') {
                showHumanSupport();
            }
            
            return "I understand you'd like to speak with a human agent. You can connect with our support team using the options below. Is there anything I can help with in the meantime?";
        }

        // Product inquiry handling
        function isProductInquiry(message, context) {
            const productTerms = ['product', 'item', 'buy', 'purchase', 'looking for', 'searching for'];
            return productTerms.some(term => message.includes(term)) || 
                   context.conversationState === 'product_discussion';
        }

        function handleProductInquiry(message) {
            // Search through available products
            const productKeywords = extractProductKeywords(message);
            let response = "";
            
            if (productKeywords.length > 0 && allProducts.length > 0) {
                // Find matching products
                const matchingProducts = searchLocalProducts(productKeywords);
                
                if (matchingProducts.length > 0) {
                    response = formatProductResponse(matchingProducts, message);
                } else {
                    response = "I couldn't find specific products matching your query. Could you provide more details or check our products page for our full catalog?";
                }
            } else {
                response = "I'd be happy to help you with products! We have a wide range of items including electronics, sports gear, and home appliances. You can browse our catalog on the products page, or tell me what specific product you're looking for and I'll provide more details.";
            }
            
            return response;
        }

        function extractProductKeywords(message) {
            const productTerms = [
                'headphone', 'watch', 'shoe', 'phone', 'laptop', 'camera', 'tablet',
                'electronics', 'clothing', 'home', 'kitchen', 'sports', 'accessories'
            ];
            
            return productTerms.filter(term => message.includes(term));
        }

        function searchLocalProducts(keywords) {
            return allProducts.filter(product => {
                const searchText = (product.name + ' ' + product.category + ' ' + (product.description || '')).toLowerCase();
                return keywords.some(keyword => searchText.includes(keyword));
            }).slice(0, 3); // Limit to 3 results
        }

        function formatProductResponse(products, originalMessage) {
            if (products.length === 1) {
                const product = products[0];
                return `I found "${product.name}" in our ${product.category} category. It's priced at KSH ${product.price.toLocaleString()} and is currently ${product.stock_quantity > 0 ? 'in stock' : 'out of stock'}. Would you like to know more about this product?`;
            } else if (products.length > 1) {
                let response = `I found several products that might interest you:\n`;
                products.forEach((product, index) => {
                    response += `\n${index + 1}. ${product.name} - KSH ${product.price.toLocaleString()} (${product.category})`;
                });
                response += `\n\nYou can view these products on our website or let me know if you'd like details about a specific one.`;
                return response;
            }
            
            return "I couldn't find specific products matching your query. Could you provide more details or check our products page for our full catalog?";
        }

        // Order inquiry handling
        function isOrderInquiry(message) {
            const orderTerms = ['order', 'track', 'status', 'delivery', 'when will', 'ship'];
            return orderTerms.some(term => message.includes(term));
        }

        function handleOrderInquiry(message) {
            if (!currentUser.isLoggedIn) {
                return "To check your order status, please log in to your account. You can then view all your orders in the 'Dashboard' section.";
            }
            
            if (currentUser.orders && currentUser.orders.length > 0) {
                const recentOrder = currentUser.orders[0];
                return `Your most recent order #${recentOrder.id} is currently "${recentOrder.status}". ${getOrderStatusDetails(recentOrder.status)} You can view all your orders in the 'Dashboard' section of your account.`;
            }
            
            return "I don't see any orders in your account yet. Once you place an order, you'll be able to track its status in your Dashboard.";
        }

        function getOrderStatusDetails(status) {
            const statusDetails = {
                'pending': 'Your order is being processed and will ship soon.',
                'shipped': 'Your order is on its way!',
                'delivered': 'Your order has been delivered. We hope you enjoy your purchase!',
                'cancelled': 'This order has been cancelled.',
                'processing': 'We are currently preparing your order for shipment.'
            };
            return statusDetails[status] || 'Your order is being processed.';
        }

        // Shipping inquiries
        function isShippingInquiry(message) {
            const shippingTerms = ['shipping', 'delivery', 'arrive', 'when get', 'ship time'];
            return shippingTerms.some(term => message.includes(term));
        }

        function handleShippingInquiry() {
            return `We offer several shipping options:\n\n‚Ä¢ **Free Standard Shipping**: 5-7 business days (orders over KSH 10,000)\n‚Ä¢ **Express Shipping**: 2-3 business days (KSH 500)\n‚Ä¢ **Same-day Delivery**: Available in Nairobi for KSH 1,500 (orders placed before 2PM)\n\nShipping times may vary based on your location. You can see estimated delivery dates during checkout.`;
        }

        // Return inquiries
        function isReturnInquiry(message) {
            const returnTerms = ['return', 'refund', 'exchange', 'send back', 'cancel order'];
            return returnTerms.some(term => message.includes(term));
        }

        function handleReturnInquiry() {
            return `Our return policy:\n\n‚Ä¢ **30-Day Return Period**: Items can be returned within 30 days of delivery\n‚Ä¢ **Condition**: Items must be in original condition with tags attached\n‚Ä¢ **Refund Method**: Refunds are issued via MPesa or original payment method\n‚Ä¢ **Process**: Contact our support team via the human support section\n\nFor defective items, please contact our support team for immediate assistance.`;
        }

        // Account inquiries
        function isAccountInquiry(message) {
            const accountTerms = ['account', 'login', 'password', 'email', 'profile'];
            return accountTerms.some(term => message.includes(term));
        }

        function handleAccountInquiry() {
            return `I can help with account-related questions:\n\n‚Ä¢ **Password Reset**: Use the 'Forgot Password' link on the login page\n‚Ä¢ **Account Information**: Update your details in the 'Dashboard' section\n‚Ä¢ **Privacy**: Review our privacy policy for data handling information\n\nFor security-sensitive changes, our support team will be happy to assist you.`;
        }

        // Price inquiries
        function isPriceInquiry(message) {
            const priceTerms = ['price', 'cost', 'expensive', 'cheap', 'discount', 'sale', 'offer'];
            return priceTerms.some(term => message.includes(term));
        }

        function handlePriceInquiry() {
            return `We strive to offer competitive pricing on all our products:\n\n‚Ä¢ **Price Matching**: Contact us about our price match policy\n‚Ä¢ **Discounts**: Check our promotions page for current sales\n‚Ä¢ **Seasonal Sales**: Major holidays often feature special discounts\n‚Ä¢ **Free Shipping**: Available on orders over KSH 10,000\n\nIs there a specific product you're interested in? I can check its current price for you.`;
        }

        // Context-aware responses
        function getContextAwareResponse(userContext) {
            const { conversationState } = userContext;

            if (conversationState === 'greeted') {
                return "Is there anything specific I can help you with today? I can assist with products, orders, shipping, returns, or general questions.";
            }

            const generalResponses = [
                "I'm here to help with your shopping needs! You can ask me about products, orders, shipping, returns, or anything else shopping-related.",
                "How can I assist you today? I can provide product information, help with orders, or answer questions about our services.",
                "I'd be happy to help! Feel free to ask about our products, your orders, shipping information, or anything else you'd like to know."
            ];

            return generalResponses[Math.floor(Math.random() * generalResponses.length)];
        }

        // Make generateAIResponse globally available
        window.generateAIResponse = generateAIResponse;
    </script>

    <script>
        // ========== E-COMMERCE & USER REGISTRATION ==========
        
        // User Management System
        let currentUser = {
            isLoggedIn: false,
            isAdmin: false,
            id: null,
            email: "guest@example.com",
            name: "Guest User",
            phone: "",
            joinedDate: new Date().toISOString().split('T')[0],
            orders: []
        };

        // Store all users (in production, this would be in a database)
        let allUsers = [
            {
                id: 1,
                email: "demo@example.com",
                name: "Demo Customer",
                phone: "0712 345 678",
                password: "password123",
                isAdmin: false,
                joinedDate: "2024-01-15",
                orders: []
            },
            {
                id: 999,
                email: "admin@shopsmart.com",
                name: "Admin User",
                phone: "0700 000 000",
                password: "admin123",
                isAdmin: true,
                joinedDate: "2024-01-01",
                orders: []
            }
        ];

        // Store all orders across the system
        let allOrders = JSON.parse(localStorage.getItem('shopSmartOrders')) || [];

        // Shopping Cart System
        let shoppingCart = JSON.parse(localStorage.getItem('shoppingCart')) || [];
        let allProducts = [];
        let adminProducts = [];

        // Socket.io connection
        let socket = null;

        // DOM Elements
        const pages = {
            auth: document.getElementById('auth-page'),
            home: document.getElementById('home-page'),
            products: document.getElementById('products-page'),
            cart: document.getElementById('cart-page'),
            dashboard: document.getElementById('dashboard-page'),
            admin: document.getElementById('admin-page')
        };

        // Initialize the application
        function initApp() {
            loadInitialData(); // Load all data first
            checkLoginStatus();
            updateCartDisplay();
            setupEventListeners();
            initializeSocket();
            initializeHumanSupport();
            
            // Start on auth page
            showPage('auth');
        }

        // Load all initial data
        function loadInitialData() {
            // Load users from localStorage
            const savedUsers = localStorage.getItem('shopSmartUsers');
            if (savedUsers) {
                allUsers = JSON.parse(savedUsers);
            }
            
            // Load orders from localStorage
            const savedOrders = localStorage.getItem('shopSmartOrders');
            if (savedOrders) {
                allOrders = JSON.parse(savedOrders);
            }
            
            // Load products
            loadProducts();
        }

        // Human Support Functions
        function initializeHumanSupport() {
            // Function to show the human support section
            window.showHumanSupport = function() {
                document.getElementById('human-support').style.display = 'block';
                // Optional: Scroll to the section
                document.getElementById('human-support').scrollIntoView({ behavior: 'smooth' });
            };
            
            // Function to hide the human support section
            window.hideHumanSupport = function() {
                document.getElementById('human-support').style.display = 'none';
            };
            
            // Event Listeners for buttons
            // Start Live Chat button
            const liveChatBtn = document.getElementById('startLiveChatBtn');
            if (liveChatBtn) {
                liveChatBtn.addEventListener('click', function() {
                    const statusEl = document.getElementById('liveChatStatus');
                    statusEl.textContent = 'Connecting you to an agent...';
                    statusEl.style.background = '#fff3cd';
                    statusEl.style.color = '#856404';
                    
                    // Simulate connection delay
                    setTimeout(() => {
                        statusEl.textContent = '‚úÖ You are now connected to a live agent!';
                        statusEl.style.background = '#d4edda';
                        statusEl.style.color = '#155724';
                    }, 1500);
                });
            }
            
            // Copy Phone Number button
            const copyPhoneBtn = document.getElementById('copyPhoneBtn');
            if (copyPhoneBtn) {
                copyPhoneBtn.addEventListener('click', function() {
                    const phoneNumber = '+254 700 123 456';
                    navigator.clipboard.writeText(phoneNumber).then(() => {
                        const originalText = copyPhoneBtn.textContent;
                        copyPhoneBtn.textContent = '‚úì Copied!';
                        copyPhoneBtn.style.background = '#28a745';
                        
                        setTimeout(() => {
                            copyPhoneBtn.textContent = originalText;
                            copyPhoneBtn.style.background = '';
                        }, 2000);
                    });
                });
            }
            
            // Request Callback button
            const callbackBtn = document.getElementById('requestCallbackBtn');
            if (callbackBtn) {
                callbackBtn.addEventListener('click', function() {
                    const phoneInput = document.getElementById('callbackNumber');
                    const statusEl = document.getElementById('callbackStatus');
                    
                    if (!phoneInput.value || phoneInput.value.length < 10) {
                        statusEl.textContent = '‚ùå Please enter a valid phone number';
                        statusEl.style.background = '#f8d7da';
                        statusEl.style.color = '#721c24';
                        return;
                    }
                    
                    statusEl.textContent = '‚è≥ Sending your request...';
                    statusEl.style.background = '#fff3cd';
                    statusEl.style.color = '#856404';
                    
                    // Simulate API request
                    setTimeout(() => {
                        statusEl.textContent = '‚úÖ Callback requested! We\'ll call ' + phoneInput.value + ' within 15 minutes.';
                        statusEl.style.background = '#d4edda';
                        statusEl.style.color = '#155724';
                        phoneInput.value = '';
                    }, 1200);
                });
            }
        }

        // Socket.io Initialization
        function initializeSocket() {
            const BACKEND_URL = "https://ecommerce-backend-jnb5.onrender.com";
            
            socket = io(BACKEND_URL, {
                transports: ['websocket', 'polling'],
                reconnection: true,
                reconnectionAttempts: 5,
                reconnectionDelay: 1000
            });
            
            // Connection events
            socket.on('connect', () => {
                console.log('üîå Connected to real-time server');
                updateConnectionStatus(true);
                
                // Join appropriate room based on user role
                if (currentUser.isLoggedIn) {
                    if (currentUser.isAdmin) {
                        socket.emit('join-admin');
                        console.log('üë®‚Äçüíº Joined admin room');
                    } else {
                        socket.emit('join-customer', currentUser.id);
                        console.log('üõí Joined customer room');
                    }
                }
            });
            
            socket.on('disconnect', () => {
                console.log('üîå Disconnected from real-time server');
                updateConnectionStatus(false);
            });
            
            socket.on('connect_error', (error) => {
                console.error('‚ùå Socket connection error:', error);
                updateConnectionStatus(false);
            });
            
            // Real-time events
            socket.on('order-created', (orderData) => {
                if (currentUser.isAdmin) {
                    showNotification(`üõçÔ∏è New Order #${orderData.id} received!`);
                    updateAdminOrders(orderData);
                }
            });
            
            socket.on('order-confirmed', (orderData) => {
                if (!currentUser.isAdmin && currentUser.id === orderData.userId) {
                    showNotification(`‚úÖ Order #${orderData.id} confirmed!`);
                }
            });
            
            socket.on('product-changed', (productData) => {
                console.log('üì¶ Product updated in real-time:', productData.name);
                
                // Update local products array
                const index = allProducts.findIndex(p => p.id === productData.id);
                if (index !== -1) {
                    allProducts[index] = productData;
                } else {
                    allProducts.push(productData);
                }
                
                // Refresh product displays
                renderAllProducts();
                renderFeaturedProducts();
                
                if (currentUser.isAdmin) {
                    renderAdminProductsTable();
                }
                
                showNotification(`üì¶ ${productData.name} updated`);
            });
            
            socket.on('product-removed', (productData) => {
                console.log('üóëÔ∏è Product removed in real-time:', productData.productId);
                
                // Remove from local array
                allProducts = allProducts.filter(p => p.id !== productData.productId);
                
                // Refresh displays
                renderAllProducts();
                renderFeaturedProducts();
                
                if (currentUser.isAdmin) {
                    adminProducts = adminProducts.filter(p => p.id !== productData.productId);
                    renderAdminProductsTable();
                    updateAdminStats();
                }
                
                showNotification('üóëÔ∏è Product removed');
            });
            
            // New user registered notification
            socket.on('user-registered', (userData) => {
                if (currentUser.isAdmin) {
                    showNotification(`üë§ New user registered: ${userData.name}`);
                    loadAdminUsers();
                }
            });
            
            // Real-time chat from server
            socket.on('receive-chat-message', (messageData) => {
                if (window.addMessage) {
                    window.addMessage(messageData.message, 'bot');
                }
            });
            
            // Live visitor count
            socket.on('visitor-count', (count) => {
                updateVisitorCount(count);
            });
            
            socket.on('visitor-update', (count) => {
                updateVisitorCount(count);
            });
        }

        function updateConnectionStatus(isConnected) {
            const indicator = document.getElementById('connection-status-indicator');
            const text = document.getElementById('connection-status-text');
            
            if (indicator && text) {
                if (isConnected) {
                    indicator.className = 'status-indicator status-online';
                    text.textContent = 'Online';
                } else {
                    indicator.className = 'status-indicator status-offline';
                    text.textContent = 'Offline';
                }
            }
        }

        function updateVisitorCount(count) {
            const visitorElement = document.getElementById('live-visitors');
            if (visitorElement) {
                visitorElement.textContent = count;
            }
        }

        // Check if user is logged in
        function checkLoginStatus() {
            const savedUser = localStorage.getItem('currentUser');
            if (savedUser) {
                currentUser = JSON.parse(savedUser);
                if (currentUser.isLoggedIn) {
                    updateUserUI();
                    showPage('home');
                }
            }
        }

        // Page Navigation
        function showPage(pageId) {
            // Hide all pages
            Object.values(pages).forEach(page => {
                page.classList.remove('active');
            });
            
            // Show selected page
            if (pages[pageId]) {
                pages[pageId].classList.add('active');
            }
            
            // Update UI based on page
            if (pageId === 'cart') {
                renderCart();
            } else if (pageId === 'dashboard') {
                updateDashboard();
            } else if (pageId === 'admin') {
                loadAdminData();
            }
            
            // Hide/show sidebar based on page
            const sidebar = document.getElementById('sidebar');
            if (pageId === 'auth') {
                if (sidebar) sidebar.style.display = 'none';
            } else {
                if (sidebar) sidebar.style.display = 'block';
            }
        }

        // Authentication System
        function setupAuthListeners() {
            // Tab switching
            document.getElementById('login-tab').addEventListener('click', function() {
                switchAuthTab('login');
            });
            
            document.getElementById('register-tab').addEventListener('click', function() {
                switchAuthTab('register');
            });
            
            // Form switching
            document.getElementById('show-register').addEventListener('click', function() {
                switchAuthTab('register');
            });
            
            document.getElementById('show-login').addEventListener('click', function() {
                switchAuthTab('login');
            });
            
            // Login button
            document.getElementById('login-btn').addEventListener('click', function() {
                const email = document.getElementById('login-email').value;
                const password = document.getElementById('login-password').value;
                
                const loginResult = loginUser(email, password);
                if (loginResult.success) {
                    document.getElementById('login-success').textContent = 'Login successful!';
                    document.getElementById('login-error').textContent = '';
                    
                    // Show success message for 1 second then redirect
                    setTimeout(() => {
                        showPage('home');
                        showNotification(`Welcome back, ${loginResult.user.name}!`);
                    }, 1000);
                } else {
                    document.getElementById('login-error').textContent = loginResult.message;
                    document.getElementById('login-success').textContent = '';
                }
            });
            
            // Register button
            document.getElementById('register-btn').addEventListener('click', function() {
                const name = document.getElementById('register-name').value;
                const email = document.getElementById('register-email').value;
                const password = document.getElementById('register-password').value;
                const confirmPassword = document.getElementById('register-confirm-password').value;
                const phone = document.getElementById('register-phone').value;
                
                const registerResult = registerUser(name, email, password, confirmPassword, phone);
                if (registerResult.success) {
                    document.getElementById('register-success').textContent = 'Registration successful! You can now login.';
                    document.getElementById('register-error').textContent = '';
                    
                    // Switch to login tab after successful registration
                    setTimeout(() => {
                        switchAuthTab('login');
                        document.getElementById('login-email').value = email;
                        document.getElementById('login-password').value = password;
                    }, 1500);
                } else {
                    document.getElementById('register-error').textContent = registerResult.message;
                    document.getElementById('register-success').textContent = '';
                }
            });
            
            // Logout button
            document.getElementById('logout-btn').addEventListener('click', logoutUser);
        }

        function switchAuthTab(tab) {
            const loginTab = document.getElementById('login-tab');
            const registerTab = document.getElementById('register-tab');
            const loginForm = document.getElementById('login-form');
            const registerForm = document.getElementById('register-form');
            
            if (tab === 'login') {
                loginTab.classList.add('active');
                registerTab.classList.remove('active');
                loginForm.style.display = 'block';
                registerForm.style.display = 'none';
            } else {
                registerTab.classList.add('active');
                loginTab.classList.remove('active');
                loginForm.style.display = 'none';
                registerForm.style.display = 'block';
            }
        }

        function loginUser(email, password) {
            // Check demo accounts first
            if (email === 'demo@example.com' && password === 'password123') {
                const demoUser = allUsers.find(u => u.email === 'demo@example.com');
                if (demoUser) {
                    completeLogin(demoUser);
                    return { success: true, user: demoUser };
                }
            }
            
            if (email === 'admin@shopsmart.com' && password === 'admin123') {
                const adminUser = allUsers.find(u => u.email === 'admin@shopsmart.com');
                if (adminUser) {
                    completeLogin(adminUser);
                    return { success: true, user: adminUser };
                }
            }
            
            // Check registered users
            const user = allUsers.find(u => u.email === email && u.password === password);
            if (user) {
                completeLogin(user);
                return { success: true, user: user };
            }
            
            return { success: false, message: 'Invalid email or password' };
        }

        function completeLogin(user) {
            currentUser = {
                isLoggedIn: true,
                isAdmin: user.isAdmin,
                id: user.id,
                email: user.email,
                name: user.name,
                phone: user.phone || '',
                joinedDate: user.joinedDate || new Date().toISOString().split('T')[0],
                orders: user.orders || []
            };
            
            localStorage.setItem('currentUser', JSON.stringify(currentUser));
            updateUserUI();
            
            // Reinitialize socket with new user
            if (socket) {
                socket.disconnect();
            }
            initializeSocket();
        }

        function registerUser(name, email, password, confirmPassword, phone) {
            // Validation
            if (!name || !email || !password || !confirmPassword) {
                return { success: false, message: 'All fields are required' };
            }
            
            if (password.length < 6) {
                return { success: false, message: 'Password must be at least 6 characters' };
            }
            
            if (password !== confirmPassword) {
                return { success: false, message: 'Passwords do not match' };
            }
            
            // Check if email already exists
            if (allUsers.some(u => u.email === email)) {
                return { success: false, message: 'Email already registered' };
            }
            
            // Create new user
            const newUserId = Math.max(...allUsers.map(u => u.id), 0) + 1;
            const newUser = {
                id: newUserId,
                email: email,
                name: name,
                phone: phone || '',
                password: password,
                isAdmin: false,
                joinedDate: new Date().toISOString().split('T')[0],
                orders: []
            };
            
            // Add to users array
            allUsers.push(newUser);
            
            // Save to localStorage
            localStorage.setItem('shopSmartUsers', JSON.stringify(allUsers));
            
            // Send real-time notification to admins
            if (socket && socket.connected) {
                socket.emit('user-registered', newUser);
            }
            
            return { success: true, message: 'Registration successful', user: newUser };
        }

        function logoutUser() {
            currentUser = {
                isLoggedIn: false,
                isAdmin: false,
                id: null,
                email: "guest@example.com",
                name: "Guest User",
                phone: "",
                joinedDate: new Date().toISOString().split('T')[0],
                orders: []
            };
            
            localStorage.setItem('currentUser', JSON.stringify(currentUser));
            updateUserUI();
            
            if (socket) {
                socket.disconnect();
            }
            
            showPage('auth');
            showNotification('Logged out successfully');
        }

        function updateUserUI() {
            // Update greeting
            const greetingElement = document.getElementById('user-greeting');
            if (greetingElement) {
                greetingElement.textContent = currentUser.name;
            }
            
            // Show/hide logout button
            const logoutBtn = document.getElementById('logout-btn');
            if (logoutBtn) {
                if (currentUser.isLoggedIn) {
                    logoutBtn.style.display = 'inline-block';
                } else {
                    logoutBtn.style.display = 'none';
                }
            }
            
            // Show/hide admin link
            const adminLink = document.getElementById('admin-link');
            if (adminLink) {
                if (currentUser.isAdmin) {
                    adminLink.style.display = 'block';
                } else {
                    adminLink.style.display = 'none';
                }
            }
            
            // Update dashboard user info
            document.getElementById('user-name').textContent = currentUser.name;
            document.getElementById('user-email').textContent = currentUser.email;
            document.getElementById('user-phone').textContent = currentUser.phone || 'Not provided';
            document.getElementById('user-joined').textContent = formatDate(currentUser.joinedDate);
        }

        // Product Management
        async function loadProducts() {
            try {
                const BACKEND_URL = "https://ecommerce-backend-jnb5.onrender.com";
                const response = await fetch(`${BACKEND_URL}/api/products`);
                const data = await response.json();
                
                if (data.products && data.products.length > 0) {
                    allProducts = data.products;
                } else {
                    // Fallback to demo products
                    allProducts = getDemoProducts();
                }
                
                renderAllProducts();
                renderFeaturedProducts();
                updateProductCount();
            } catch (error) {
                console.error('Error loading products:', error);
                allProducts = getDemoProducts();
                renderAllProducts();
                renderFeaturedProducts();
                updateProductCount();
            }
        }

        function getDemoProducts() {
            return [
                { 
                    id: 1, 
                    name: 'Wireless Headphones', 
                    price: 30000, 
                    category: 'Electronics', 
                    image: 'https://images.unsplash.com/photo-1505740420928-5e560c06d30e?w=400&auto=format&fit=crop',
                    description: 'Premium wireless headphones with noise cancellation',
                    stock_quantity: 50,
                    featured: true
                },
                { 
                    id: 2, 
                    name: 'Smart Watch', 
                    price: 45000, 
                    category: 'Electronics', 
                    image: 'https://images.unsplash.com/photo-1523275335684-37898b6baf30?w=400&auto=format&fit=crop',
                    description: 'Fitness tracker with heart rate monitor',
                    stock_quantity: 30,
                    featured: true
                },
                { 
                    id: 3, 
                    name: 'Running Shoes', 
                    price: 13500, 
                    category: 'Sports', 
                    image: 'https://images.unsplash.com/photo-1542291026-7eec264c27ff?w=400&auto=format&fit=crop',
                    description: 'Professional running shoes with cushioning',
                    stock_quantity: 100,
                    featured: false
                },
                { 
                    id: 4, 
                    name: 'Coffee Maker', 
                    price: 22500, 
                    category: 'Home', 
                    image: 'https://images.unsplash.com/photo-1495474472287-4d71bcdd2085?w=400&auto=format&fit=crop',
                    description: 'Automatic coffee maker with grinder',
                    stock_quantity: 25,
                    featured: true
                }
            ];
        }

        // ========== PRODUCT RENDERING FUNCTION ==========
        function renderProductCard(product) {
            const defaultImage = 'https://images.unsplash.com/photo-1556656793-08538906a9f8?w=400&auto=format&fit=crop';
            
            return `
                <img src="${product.image || product.image_url || defaultImage}" 
                     alt="${product.name}" 
                     style="width: 100%; height: 200px; object-fit: cover; border-radius: 8px; margin-bottom: 15px;">
                <h3>${product.name}</h3>
                <p class="price">ksh. ${product.price.toLocaleString()}</p>
                <p style="color: #666; font-size: 0.9rem; margin-bottom: 15px;">${product.category || 'General'}</p>
                <div>
                    <button class="btn" onclick="addToCart(${product.id})">
                        Add to Cart
                    </button>
                    <button class="btn-secondary" onclick="viewProductDetails(${product.id})">
                        Details
                    </button>
                </div>
            `;
        }

        function renderAllProducts() {
            const container = document.getElementById('all-products');
            if (!container) return;
            
            container.innerHTML = allProducts.map(product => `
                <div class="product-card" data-category="${product.category}">
                    ${renderProductCard(product)}
                </div>
            `).join('');
        }

        function renderFeaturedProducts() {
            const container = document.getElementById('featured-products');
            if (!container) return;
            
            const featured = allProducts.filter(p => p.featured).slice(0, 3);
            container.innerHTML = featured.map(product => `
                <div class="product-card">
                    ${renderProductCard(product)}
                </div>
            `).join('');
            
            document.getElementById('total-products').textContent = allProducts.length;
        }

        // ========== ADMIN FUNCTIONS ==========
        function loadAdminData() {
            // Load products for admin table
            adminProducts = [...allProducts];
            renderAdminProductsTable();
            loadAdminUsers();
            loadAdminOrders();
            updateAdminStats();
        }

        function loadAdminUsers() {
            const tableBody = document.getElementById('admin-users-table');
            if (!tableBody) return;
            
            if (allUsers.length === 0) {
                tableBody.innerHTML = `<tr><td colspan="8" class="text-center">No users found</td></tr>`;
                return;
            }
            
            tableBody.innerHTML = allUsers.map(user => {
                // Count user's orders
                const userOrders = allOrders.filter(order => order.userId === user.id);
                
                return `
                <tr>
                    <td>${user.id}</td>
                    <td><strong>${user.name}</strong></td>
                    <td>${user.email}</td>
                    <td>${user.phone || 'N/A'}</td>
                    <td><span class="user-role ${user.isAdmin ? 'role-admin' : 'role-customer'}">${user.isAdmin ? 'Admin' : 'Customer'}</span></td>
                    <td>${formatDate(user.joinedDate)}</td>
                    <td>${userOrders.length}</td>
                    <td>
                        <button class="btn-secondary" onclick="editUser(${user.id})" style="padding: 5px 10px; font-size: 0.9rem;">Edit</button>
                        ${user.id !== 999 && user.id !== currentUser.id ? 
                            `<button class="btn-danger" onclick="deleteUser(${user.id})" style="padding: 5px 10px; font-size: 0.9rem;">Delete</button>` : 
                            '<button class="btn-secondary" disabled style="padding: 5px 10px; font-size: 0.9rem;">Delete</button>'
                        }
                    </td>
                </tr>
            `}).join('');
            
            // Update admin stats
            document.getElementById('admin-total-users').textContent = allUsers.length;
        }

        function loadAdminOrders() {
            const tableBody = document.getElementById('admin-orders-table');
            if (!tableBody) return;
            
            if (allOrders.length === 0) {
                tableBody.innerHTML = `<tr><td colspan="6" class="text-center">No orders found</td></tr>`;
                return;
            }
            
            tableBody.innerHTML = allOrders.map(order => {
                // Find user for this order
                const user = allUsers.find(u => u.id === order.userId);
                const userName = user ? user.name : 'Unknown User';
                
                return `
                <tr>
                    <td>#${order.id}</td>
                    <td>${userName}</td>
                    <td>${order.date}</td>
                    <td>ksh. ${order.total.toLocaleString()}</td>
                    <td><span class="order-status status-${order.status}">${order.status}</span></td>
                    <td>
                        <button class="btn-secondary" onclick="updateOrderStatus(${order.id})" style="padding: 5px 10px; font-size: 0.9rem;">Update Status</button>
                    </td>
                </tr>
            `}).join('');
            
            // Update admin stats
            document.getElementById('admin-total-orders').textContent = allOrders.length;
            
            // Calculate total revenue
            const totalRevenue = allOrders.reduce((sum, order) => sum + order.total, 0);
            document.getElementById('admin-total-revenue').textContent = totalRevenue.toLocaleString();
        }

        function renderAdminProductsTable() {
            const tableBody = document.getElementById('admin-products-table');
            if (!tableBody) return;
            
            if (adminProducts.length === 0) {
                tableBody.innerHTML = `<tr><td colspan="7" class="text-center">No products found</td></tr>`;
                return;
            }
            
            tableBody.innerHTML = adminProducts.map(product => `
                <tr>
                    <td>${product.id}</td>
                    <td>
                        <img src="${product.image || product.image_url || 'https://via.placeholder.com/50'}" 
                             alt="${product.name}" 
                             style="width: 50px; height: 50px; object-fit: cover; border-radius: 5px;">
                    </td>
                    <td><strong>${product.name}</strong></td>
                    <td>ksh. ${product.price.toLocaleString()}</td>
                    <td><span style="padding: 5px 10px; background: #e9ecef; border-radius: 15px;">${product.category}</span></td>
                    <td>${product.stock_quantity || 0}</td>
                    <td>
                        <button class="btn-secondary" onclick="editProduct(${product.id})" style="padding: 5px 10px; font-size: 0.9rem;">Edit</button>
                        <button class="btn-danger" onclick="deleteProduct(${product.id})" style="padding: 5px 10px; font-size: 0.9rem;">Delete</button>
                    </td>
                </tr>
            `).join('');
        }

        function updateAdminStats() {
            const totalProductsElem = document.getElementById('admin-total-products');
            const totalOrdersElem = document.getElementById('admin-total-orders');
            const totalRevenueElem = document.getElementById('admin-total-revenue');
            
            if (totalProductsElem) totalProductsElem.textContent = adminProducts.length;
            if (totalOrdersElem) totalOrdersElem.textContent = allOrders.length;
            
            if (totalRevenueElem) {
                const totalRevenue = allOrders.reduce((sum, order) => sum + order.total, 0);
                totalRevenueElem.textContent = totalRevenue.toLocaleString();
            }
        }

        // User Management Functions
        function editUser(userId) {
            const user = allUsers.find(u => u.id === userId);
            if (!user) return;
            
            document.getElementById('user-modal-title').textContent = 'Edit User';
            document.getElementById('edit-user-id').value = user.id;
            document.getElementById('edit-user-name').value = user.name;
            document.getElementById('edit-user-email').value = user.email;
            document.getElementById('edit-user-phone').value = user.phone || '';
            document.getElementById('edit-user-role').value = user.isAdmin ? 'admin' : 'customer';
            
            document.getElementById('user-modal').classList.add('active');
        }

        function deleteUser(userId) {
            // Prevent deleting demo admin or current user
            if (userId === 999) {
                showNotification('Cannot delete demo admin account');
                return;
            }
            
            if (userId === currentUser.id) {
                showNotification('Cannot delete your own account');
                return;
            }
            
            if (confirm('Are you sure you want to delete this user?')) {
                allUsers = allUsers.filter(u => u.id !== userId);
                localStorage.setItem('shopSmartUsers', JSON.stringify(allUsers));
                loadAdminUsers();
                showNotification('User deleted successfully');
            }
        }

        function saveUser(event) {
            event.preventDefault();
            
            const userId = parseInt(document.getElementById('edit-user-id').value);
            const name = document.getElementById('edit-user-name').value;
            const email = document.getElementById('edit-user-email').value;
            const phone = document.getElementById('edit-user-phone').value;
            const role = document.getElementById('edit-user-role').value;
            
            const userIndex = allUsers.findIndex(u => u.id === userId);
            if (userIndex !== -1) {
                allUsers[userIndex] = {
                    ...allUsers[userIndex],
                    name: name,
                    email: email,
                    phone: phone,
                    isAdmin: role === 'admin'
                };
                
                localStorage.setItem('shopSmartUsers', JSON.stringify(allUsers));
                loadAdminUsers();
                
                // If editing current user, update UI
                if (userId === currentUser.id) {
                    currentUser.name = name;
                    currentUser.email = email;
                    currentUser.phone = phone;
                    currentUser.isAdmin = role === 'admin';
                    localStorage.setItem('currentUser', JSON.stringify(currentUser));
                    updateUserUI();
                }
                
                showNotification('User updated successfully');
            }
            
            document.getElementById('user-modal').classList.remove('active');
        }

        // Product CRUD Operations
        function addProduct() {
            document.getElementById('product-modal-title').textContent = 'Add New Product';
            document.getElementById('product-form').reset();
            document.getElementById('product-id').value = '';
            document.getElementById('product-modal').classList.add('active');
        }

        function editProduct(productId) {
            const product = adminProducts.find(p => p.id === productId);
            if (!product) return;
            
            document.getElementById('product-modal-title').textContent = 'Edit Product';
            document.getElementById('product-id').value = product.id;
            document.getElementById('product-name').value = product.name;
            document.getElementById('product-price').value = product.price;
            document.getElementById('product-category').value = product.category;
            document.getElementById('product-stock').value = product.stock_quantity || 0;
            document.getElementById('product-image').value = product.image || product.image_url || '';
            document.getElementById('product-description').value = product.description || '';
            document.getElementById('product-featured').value = product.featured || 'false';
            
            document.getElementById('product-modal').classList.add('active');
        }

        function deleteProduct(productId) {
            if (confirm('Are you sure you want to delete this product?')) {
                // Remove from local array
                adminProducts = adminProducts.filter(p => p.id !== productId);
                allProducts = allProducts.filter(p => p.id !== productId);
                
                // Send real-time notification
                if (socket && socket.connected) {
                    socket.emit('product-deleted', productId);
                }
                
                // Update UI
                renderAdminProductsTable();
                renderAllProducts();
                renderFeaturedProducts();
                updateAdminStats();
                updateProductCount();
                
                showNotification('Product deleted successfully');
            }
        }

        function saveProduct(event) {
            event.preventDefault();
            
            const productId = document.getElementById('product-id').value;
            const productData = {
                name: document.getElementById('product-name').value,
                price: parseFloat(document.getElementById('product-price').value),
                category: document.getElementById('product-category').value,
                stock_quantity: parseInt(document.getElementById('product-stock').value),
                image_url: document.getElementById('product-image').value || undefined,
                description: document.getElementById('product-description').value,
                featured: document.getElementById('product-featured').value === 'true'
            };
            
            if (productId) {
                // Update existing product
                const index = adminProducts.findIndex(p => p.id === parseInt(productId));
                if (index !== -1) {
                    const updatedProduct = { ...adminProducts[index], ...productData, id: parseInt(productId) };
                    adminProducts[index] = updatedProduct;
                    allProducts = allProducts.map(p => p.id === parseInt(productId) ? updatedProduct : p);
                    
                    // Send real-time update
                    if (socket && socket.connected) {
                        socket.emit('product-updated', updatedProduct);
                    }
                }
                showNotification('Product updated successfully');
            } else {
                // Add new product
                const newId = Math.max(...adminProducts.map(p => p.id), 0) + 1;
                const newProduct = { id: newId, ...productData };
                adminProducts.push(newProduct);
                allProducts.push(newProduct);
                
                // Send real-time update
                if (socket && socket.connected) {
                    socket.emit('product-updated', newProduct);
                }
                
                showNotification('Product added successfully');
            }
            
            // Update UI
            renderAdminProductsTable();
            renderAllProducts();
            renderFeaturedProducts();
            updateAdminStats();
            updateProductCount();
            
            // Close modal
            document.getElementById('product-modal').classList.remove('active');
        }

        // Order Management Functions
        function updateOrderStatus(orderId) {
            const order = allOrders.find(o => o.id === orderId);
            if (!order) return;
            
            const newStatus = prompt('Enter new status (pending, processing, shipped, delivered, cancelled):', order.status);
            if (newStatus && ['pending', 'processing', 'shipped', 'delivered', 'cancelled'].includes(newStatus)) {
                order.status = newStatus;
                localStorage.setItem('shopSmartOrders', JSON.stringify(allOrders));
                loadAdminOrders();
                showNotification(`Order #${orderId} status updated to ${newStatus}`);
            }
        }

        // Shopping Cart Functions
        function addToCart(productId) {
            if (!currentUser.isLoggedIn) {
                showNotification('Please login to add items to cart');
                showPage('auth');
                return;
            }
            
            const product = allProducts.find(p => p.id === productId);
            if (!product) return;
            
            const existingItem = shoppingCart.find(item => item.id === productId);
            
            if (existingItem) {
                existingItem.quantity += 1;
            } else {
                shoppingCart.push({
                    ...product,
                    quantity: 1
                });
            }
            
            saveCart();
            updateCartDisplay();
            showNotification(`Added ${product.name} to cart!`);
        }

        function removeFromCart(productId) {
            shoppingCart = shoppingCart.filter(item => item.id !== productId);
            saveCart();
            updateCartDisplay();
            renderCart();
        }

        function updateQuantity(productId, change) {
            const item = shoppingCart.find(item => item.id === productId);
            if (item) {
                item.quantity += change;
                if (item.quantity < 1) {
                    removeFromCart(productId);
                } else {
                    saveCart();
                    updateCartDisplay();
                    renderCart();
                }
            }
        }

        function saveCart() {
            localStorage.setItem('shoppingCart', JSON.stringify(shoppingCart));
        }

        function updateCartDisplay() {
            const totalItems = shoppingCart.reduce((sum, item) => sum + item.quantity, 0);
            const cartTotal = shoppingCart.reduce((sum, item) => sum + (item.price * item.quantity), 0);
            
            document.getElementById('cart-count').textContent = totalItems;
            document.getElementById('sidebar-cart-count').textContent = totalItems;
            document.getElementById('sidebar-cart-total').textContent = cartTotal.toLocaleString();
            document.getElementById('home-cart-total').textContent = cartTotal.toLocaleString();
            document.getElementById('dashboard-cart-count').textContent = totalItems;
        }

        function renderCart() {
            const container = document.getElementById('cart-items-container');
            if (!container) return;
            
            if (shoppingCart.length === 0) {
                container.innerHTML = '<div class="text-center" style="padding: 40px; color: #666;">Your cart is empty</div>';
                updateCheckoutSummary(0);
                return;
            }
            
            container.innerHTML = shoppingCart.map(item => `
                <div class="cart-item">
                    <div class="cart-item-info">
                        <h4>${item.name}</h4>
                        <p>ksh. ${item.price.toLocaleString()} each</p>
                    </div>
                    <div class="cart-item-controls">
                        <div class="quantity-control">
                            <button class="quantity-btn" onclick="updateQuantity(${item.id}, -1)">-</button>
                            <span style="min-width: 30px; text-align: center;">${item.quantity}</span>
                            <button class="quantity-btn" onclick="updateQuantity(${item.id}, 1)">+</button>
                        </div>
                        <div style="min-width: 100px; text-align: right;">
                            ksh. ${(item.price * item.quantity).toLocaleString()}
                        </div>
                        <button class="btn-danger" onclick="removeFromCart(${item.id})">
                            Remove
                        </button>
                    </div>
                </div>
            `).join('');
            
            const subtotal = shoppingCart.reduce((sum, item) => sum + (item.price * item.quantity), 0);
            updateCheckoutSummary(subtotal);
        }

        function updateCheckoutSummary(subtotal) {
            const shipping = subtotal > 10000 ? 0 : 500;
            const tax = subtotal * 0.1;
            const total = subtotal + shipping + tax;
            
            document.getElementById('subtotal').textContent = subtotal.toLocaleString();
            document.getElementById('shipping').textContent = shipping.toLocaleString();
            document.getElementById('tax').textContent = tax.toLocaleString();
            document.getElementById('total').textContent = total.toLocaleString();
        }

        // Additional Functions
        function formatDate(dateString) {
            if (!dateString) return 'Unknown';
            const date = new Date(dateString);
            return date.toLocaleDateString('en-US', { year: 'numeric', month: 'short', day: 'numeric' });
        }

        function updateProductCount() {
            document.getElementById('product-count').textContent = allProducts.length;
        }

        function showNotification(message) {
            const notification = document.createElement('div');
            notification.textContent = message;
            notification.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                background: #28a745;
                color: white;
                padding: 15px 20px;
                border-radius: 5px;
                z-index: 3000;
                animation: slideIn 0.3s ease;
            `;
            
            document.body.appendChild(notification);
            
            setTimeout(() => {
                notification.style.animation = 'slideOut 0.3s ease';
                setTimeout(() => notification.remove(), 300);
            }, 3000);
        }

        function viewProductDetails(productId) {
            const product = allProducts.find(p => p.id === productId);
            if (!product) return;
            
            alert(`${product.name}\n\nPrice: ksh. ${product.price.toLocaleString()}\nCategory: ${product.category}\nStock: ${product.stock_quantity || 0}\n\n${product.description || 'No description available'}`);
        }

        // Setup Event Listeners
        function setupEventListeners() {
            // Auth listeners
            setupAuthListeners();
            
            // Navigation
            document.querySelectorAll('[data-page]').forEach(link => {
                link.addEventListener('click', function(e) {
                    e.preventDefault();
                    if (!currentUser.isLoggedIn && this.getAttribute('data-page') !== 'auth') {
                        showNotification('Please login first');
                        showPage('auth');
                        return;
                    }
                    const pageId = this.getAttribute('data-page');
                    if (pageId === 'admin' && !currentUser.isAdmin) {
                        showNotification('Admin access required');
                        return;
                    }
                    showPage(pageId);
                });
            });
            
            // Category filters
            function setupCategoryFilters() {
                const categoryButtons = document.querySelectorAll('.category-btn');
                
                categoryButtons.forEach(button => {
                    button.addEventListener('click', function() {
                        const category = this.getAttribute('data-category');
                        
                        // Remove active class from all buttons
                        categoryButtons.forEach(btn => btn.classList.remove('active'));
                        // Add active class to clicked button
                        this.classList.add('active');
                        
                        // Show/hide products based on category
                        filterProductsByCategory(category);
                    });
                });
            }
            
            setupCategoryFilters();
            
            // Admin buttons
            document.getElementById('add-product-btn').addEventListener('click', addProduct);
            document.getElementById('view-users-btn').addEventListener('click', loadAdminUsers);
            document.getElementById('refresh-admin-btn').addEventListener('click', loadAdminData);
            document.getElementById('save-product-btn').addEventListener('click', saveProduct);
            document.getElementById('save-user-btn').addEventListener('click', saveUser);
            document.getElementById('cancel-product').addEventListener('click', function() {
                document.getElementById('product-modal').classList.remove('active');
            });
            document.getElementById('cancel-user').addEventListener('click', function() {
                document.getElementById('user-modal').classList.remove('active');
            });
            
            // Checkout
            const checkoutBtn = document.getElementById('checkout-btn');
            const cancelCheckoutBtn = document.getElementById('cancel-checkout');
            const checkoutModal = document.getElementById('checkout-modal');
            const checkoutForm = document.getElementById('checkout-form');
            
            if (checkoutBtn) {
                checkoutBtn.addEventListener('click', function() {
                    if (shoppingCart.length === 0) {
                        alert('Your cart is empty!');
                        return;
                    }
                    
                    // Pre-fill checkout form with user info
                    document.getElementById('checkout-name').value = currentUser.name;
                    document.getElementById('checkout-email').value = currentUser.email;
                    document.getElementById('checkout-phone').value = currentUser.phone || '';
                    
                    const total = shoppingCart.reduce((sum, item) => sum + (item.price * item.quantity), 0);
                    document.getElementById('checkout-total').textContent = total.toLocaleString();
                    checkoutModal.classList.add('active');
                });
            }
            
            if (cancelCheckoutBtn) {
                cancelCheckoutBtn.addEventListener('click', function() {
                    checkoutModal.classList.remove('active');
                });
            }
            
            if (checkoutForm) {
                checkoutForm.addEventListener('submit', function(e) {
                    e.preventDefault();
                    processOrder();
                });
            }
            
            // Quick admin actions
            document.getElementById('export-products-btn').addEventListener('click', function() {
                const dataStr = JSON.stringify(adminProducts, null, 2);
                const dataUri = 'data:application/json;charset=utf-8,'+ encodeURIComponent(dataStr);
                const exportFileDefaultName = 'products_export.json';
                
                const linkElement = document.createElement('a');
                linkElement.setAttribute('href', dataUri);
                linkElement.setAttribute('download', exportFileDefaultName);
                linkElement.click();
                
                showNotification('Products exported successfully');
            });
            
            document.getElementById('export-users-btn').addEventListener('click', function() {
                const dataStr = JSON.stringify(allUsers, null, 2);
                const dataUri = 'data:application/json;charset=utf-8,'+ encodeURIComponent(dataStr);
                const exportFileDefaultName = 'users_export.json';
                
                const linkElement = document.createElement('a');
                linkElement.setAttribute('href', dataUri);
                linkElement.setAttribute('download', exportFileDefaultName);
                linkElement.click();
                
                showNotification('Users exported successfully');
            });
            
            document.getElementById('reset-demo-btn').addEventListener('click', function() {
                if (confirm('Reset all demo data? This will clear all local data.')) {
                    localStorage.clear();
                    location.reload();
                }
            });
        }

        function filterProductsByCategory(category) {
            const productCards = document.querySelectorAll('.product-card');
            
            let visibleCount = 0;
            productCards.forEach(card => {
                if (category === 'all' || card.getAttribute('data-category') === category) {
                    card.style.display = 'block';
                    visibleCount++;
                } else {
                    card.style.display = 'none';
                }
            });
            
            document.getElementById('product-count').textContent = visibleCount;
        }

        function processOrder() {
            const name = document.getElementById('checkout-name').value;
            const email = document.getElementById('checkout-email').value;
            const phone = document.getElementById('checkout-phone').value;
            const address = document.getElementById('checkout-address').value;
            const paymentMethod = document.getElementById('checkout-payment').value;
            
            const order = {
                id: Date.now(),
                date: new Date().toLocaleDateString(),
                items: [...shoppingCart],
                total: shoppingCart.reduce((sum, item) => sum + (item.price * item.quantity), 0),
                status: 'processing',
                userId: currentUser.id,
                customerName: name,
                customerEmail: email,
                customerPhone: phone,
                shippingAddress: address,
                paymentMethod: paymentMethod
            };
            
            // Add order to allOrders array
            allOrders.push(order);
            localStorage.setItem('shopSmartOrders', JSON.stringify(allOrders));
            
            // Add order to current user
            if (!currentUser.orders) currentUser.orders = [];
            currentUser.orders.push(order);
            localStorage.setItem('currentUser', JSON.stringify(currentUser));
            
            // Also update in allUsers array
            const userIndex = allUsers.findIndex(u => u.id === currentUser.id);
            if (userIndex !== -1) {
                if (!allUsers[userIndex].orders) allUsers[userIndex].orders = [];
                allUsers[userIndex].orders.push(order);
                localStorage.setItem('shopSmartUsers', JSON.stringify(allUsers));
            }
            
            // Clear cart
            shoppingCart = [];
            saveCart();
            updateCartDisplay();
            renderCart();
            
            // Close modal
            document.getElementById('checkout-modal').classList.remove('active');
            
            // Send real-time notification
            if (socket && socket.connected) {
                socket.emit('new-order', order);
            }
            
            // Show success message
            alert(`‚úÖ Order #${order.id} placed successfully!\nTotal: ksh. ${order.total.toLocaleString()}\nEstimated delivery: 3-5 business days`);
            
            // Update dashboard
            updateDashboard();
            
            // Update admin data if admin is viewing
            if (currentUser.isAdmin) {
                loadAdminOrders();
                updateAdminStats();
            }
            
            // Show dashboard
            showPage('dashboard');
        }

        function updateDashboard() {
            const totalOrders = currentUser.orders ? currentUser.orders.length : 0;
            const totalSpent = currentUser.orders ? currentUser.orders.reduce((sum, order) => sum + order.total, 0) : 0;
            
            document.getElementById('total-orders').textContent = totalOrders;
            document.getElementById('total-spent').textContent = totalSpent.toLocaleString();
            document.getElementById('user-name').textContent = currentUser.name;
            document.getElementById('user-email').textContent = currentUser.email;
            
            renderOrderHistory();
        }

        function renderOrderHistory() {
            const container = document.getElementById('order-history');
            if (!container) return;
            
            if (!currentUser.orders || currentUser.orders.length === 0) {
                container.innerHTML = '<p>No orders yet</p>';
                return;
            }
            
            container.innerHTML = currentUser.orders.slice(-3).reverse().map(order => `
                <div class="order-card">
                    <div class="order-header">
                        <div>
                            <strong>Order #${order.id}</strong><br>
                            <small>${order.date}</small>
                        </div>
                        <span class="order-status status-${order.status}">${order.status}</span>
                    </div>
                    <p>${order.items.map(item => `${item.name} (${item.quantity})`).join(', ')}</p>
                    <p>Total: ksh. ${order.total.toLocaleString()}</p>
                </div>
            `).join('');
        }

        // Make functions globally available
        window.addToCart = addToCart;
        window.removeFromCart = removeFromCart;
        window.updateQuantity = updateQuantity;
        window.viewProductDetails = viewProductDetails;
        window.editProduct = editProduct;
        window.deleteProduct = deleteProduct;
        window.editUser = editUser;
        window.deleteUser = deleteUser;
        window.updateOrderStatus = updateOrderStatus;

        // Initialize the app
        window.addEventListener('DOMContentLoaded', function() {
            initApp();
            console.log('ShopSmart E-commerce with enhanced chatbot initialized');
        });
    </script>
</body>
</html>